!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e(require("quill")):"function"==typeof define&&define.amd?define(["quill"],e):"object"==typeof exports?exports.quillBetterTable=e(require("quill")):t.quillBetterTable=e(t.Quill)}(self,(t=>(()=>{"use strict";var e={912:e=>{e.exports=t}},o={};function l(t){var i=o[t];if(void 0!==i)return i.exports;var s=o[t]={exports:{}};return e[t](s,s.exports,l),s.exports}l.n=t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return l.d(e,{a:e}),e},l.d=(t,e)=>{for(var o in e)l.o(e,o)&&!l.o(t,o)&&Object.defineProperty(t,o,{enumerable:!0,get:e[o]})},l.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e);var i={};l.d(i,{default:()=>_});var s=l(912),n=l.n(s);function r(t,e){if("object"==typeof e)for(let o in e)t.style[o]=e[o]}function a(t,e){let o=e.getBoundingClientRect();return{x:t.x-o.x-e.scrollLeft,y:t.y-o.y-e.scrollTop,x1:t.x-o.x-e.scrollLeft+t.width,y1:t.y-o.y-e.scrollTop+t.height,width:t.width,height:t.height}}function d(t,e){return t&&Object.keys(t).reduce(((o,l)=>e.includes(l)?o:Object.assign({},o,{[l]:t[l]})),{})}function c(t){let e;if(e=t.path||t.composedPath&&t.composedPath(),null==e&&t.target){e=[];let o=t.target;for(e.push(o);o&&o.parentNode;)o=o.parentNode,e.push(o)}return e}class h{constructor(t,e,o){if(!t)return null;this.table=t,this.quill=e,this.options=o,this.domNode=null,this.initColTool()}initColTool(){const t=this.quill.root.parentNode,e=(this.table.getBoundingClientRect(),t.getBoundingClientRect()),o=this.table.parentNode.getBoundingClientRect();this.domNode=document.createElement("div"),this.domNode.classList.add("qlbt-col-tool"),this.updateToolCells(),t.appendChild(this.domNode),r(this.domNode,{width:`${o.width}px`,height:"12px",left:`${o.left-e.left+t.scrollLeft}px`,top:o.top-e.top+t.scrollTop-12-5+"px"})}createToolCell(){const t=document.createElement("div");t.classList.add("qlbt-col-tool-cell");const e=document.createElement("div");return e.classList.add("qlbt-col-tool-cell-holder"),r(t,{height:"12px"}),t.appendChild(e),t}updateToolCells(){const t=n().find(this.table),e=t.children.tail.children.head.children,o=t.colGroup().children,l=function(t){return t.reduce(((t,e)=>{const o=e.formats().colspan;return t+parseInt(o,10)}),0)}(e);let i=Array.from(this.domNode.querySelectorAll(".qlbt-col-tool-cell"));for(let t=0;t<Math.max(l,i.length);t++){let e=o.at(t),s=e&&parseInt(e.formats()[e.statics.blotName].width,10),n=null;i[t]?i[t]&&t>=l?i[t].remove():(n=i[t],r(n,{"min-width":`${s}px`})):(n=this.createToolCell(),this.domNode.appendChild(n),this.addColCellHolderHandler(n),r(n,{"min-width":`${s}px`}))}}destroy(){return this.domNode.remove(),null}addColCellHolderHandler(t){const e=n().find(this.table),o=t.querySelector(".qlbt-col-tool-cell-holder");let l=!1,i=0,s=0,a=0,d=0,c={},h={},u=null;const p=t=>{t.preventDefault(),l&&(s=t.clientX,a=d+s-i>=50?s-i:50-d,r(u,{left:`${h.left+h.width-1+a}px`}))},m=n=>{n.preventDefault();const b=Array.from(this.domNode.querySelectorAll(".qlbt-col-tool-cell")).indexOf(t),g=e.colGroup().children.at(b);l&&(g.format("width",d+a),r(t,{"min-width":`${d+a}px`}),i=0,s=0,a=0,d=0,l=!1,o.classList.remove("dragging")),document.removeEventListener("mousemove",p,!1),document.removeEventListener("mouseup",m,!1),c={},h={},u.remove(),u=null,e.updateTableWidth();const f=this.quill.getModule("better-table").tableSelection;f&&f.clearSelection()};o.addEventListener("mousedown",(e=>{document.addEventListener("mousemove",p,!1),document.addEventListener("mouseup",m,!1),c=this.table.getBoundingClientRect(),h=t.getBoundingClientRect(),u=document.createElement("div"),r(u,{position:"fixed",top:`${h.top}px`,left:h.left+h.width-1+"px",zIndex:1/0,height:`${c.height+12+4}px`,width:"1px",backgroundColor:"#35A7ED"}),document.body.appendChild(u),l=!0,i=e.clientX,d=h.width,o.classList.add("dragging")}),!1)}colToolCells(){return Array.from(this.domNode.querySelectorAll(".qlbt-col-tool-cell"))}}const u=n().import("blots/block");class p extends u{static create(t){"string"==typeof t&&(t={value:t});const e=super.create(t.value);return x.forEach((o=>{t[o]&&e.setAttribute(`data-${o}`,t[o])})),N.forEach((o=>{t[o]&&e.setAttribute(`data-${o}`,t[o])})),e}static formats(t){const e={};return e.value=this.tagName.indexOf(t.tagName)+1,N.concat(x).reduce(((e,o)=>(t.hasAttribute(`data-${o}`)&&(e[o]=t.getAttribute(`data-${o}`)||void 0),e)),e)}format(t,e){const{row:o,cell:l,rowspan:i,colspan:s}=p.formats(this.domNode);t===p.blotName?e?super.format(t,{value:e,row:o,cell:l,rowspan:i,colspan:s}):o?this.replaceWith(C.blotName,{row:o,cell:l,rowspan:i,colspan:s}):super.format(t,e):super.format(t,e)}optimize(t){const{row:e,rowspan:o,colspan:l}=p.formats(this.domNode);if(!e||this.parent instanceof q||this.wrap(q.blotName,{row:e,colspan:l,rowspan:o}),this.enforceAllowedChildren(),null!=this.uiNode&&this.uiNode!==this.domNode.firstChild&&this.domNode.insertBefore(this.uiNode,this.domNode.firstChild),0===this.children.length)if(null!=this.statics.defaultChild){const t=this.scroll.create(this.statics.defaultChild.blotName);this.appendChild(t)}else this.remove();this.cache={}}}p.blotName="header",p.tagName=["H1","H2","H3","H4","H5","H6"];const m=p,b=n().import("blots/break"),g=n().import("blots/block"),f=n().import("blots/container"),w=["width"],v={width:100},x=["row","cell"],N=["rowspan","colspan"],y={rowspan:1,colspan:1};class C extends g{static create(t){const e=super.create(t);return x.forEach((o=>{let l="row"===o?M:R;e.setAttribute(`data-${o}`,t[o]||l())})),N.forEach((o=>{e.setAttribute(`data-${o}`,t[o]||y[o])})),t["cell-bg"]&&e.setAttribute("data-cell-bg",t["cell-bg"]),e}static formats(t){return N.concat(x).concat(["cell-bg"]).reduce(((e,o)=>(t.hasAttribute(`data-${o}`)&&(e[o]=t.getAttribute(`data-${o}`)||void 0),e)),{})}format(t,e){if(N.concat(x).indexOf(t)>-1)e?this.domNode.setAttribute(`data-${t}`,e):this.domNode.removeAttribute(`data-${t}`);else if("cell-bg"===t)e?this.domNode.setAttribute("data-cell-bg",e):this.domNode.removeAttribute("data-cell-bg");else if("header"===t){if(!e)return;const{row:o,cell:l,rowspan:i,colspan:s}=C.formats(this.domNode);super.format(t,{value:e,row:o,cell:l,rowspan:i,colspan:s})}else super.format(t,e)}optimize(t){const e=this.domNode.getAttribute("data-row"),o=this.domNode.getAttribute("data-rowspan"),l=this.domNode.getAttribute("data-colspan"),i=this.domNode.getAttribute("data-cell-bg");!this.statics.requiredContainer||this.parent instanceof this.statics.requiredContainer||this.wrap(this.statics.requiredContainer.blotName,{row:e,colspan:l,rowspan:o,"cell-bg":i}),super.optimize(t)}tableCell(){return this.parent}}C.blotName="table-cell-line",C.className="qlbt-cell-line",C.tagName="P";class q extends f{checkMerge(){if(super.checkMerge()&&null!=this.next.children.head){const t=this.children.head.formats()[this.children.head.statics.blotName],e=this.children.tail.formats()[this.children.tail.statics.blotName],o=this.next.children.head.formats()[this.next.children.head.statics.blotName],l=this.next.children.tail.formats()[this.next.children.tail.statics.blotName];return t.cell===e.cell&&t.cell===o.cell&&t.cell===l.cell}return!1}static create(t){const e=super.create(t);return e.setAttribute("data-row",t.row),N.forEach((o=>{t[o]&&e.setAttribute(o,t[o])})),t["cell-bg"]&&(e.setAttribute("data-cell-bg",t["cell-bg"]),e.style.backgroundColor=t["cell-bg"]),e}static formats(t){const e={};return t.hasAttribute("data-row")&&(e.row=t.getAttribute("data-row")),t.hasAttribute("data-cell-bg")&&(e["cell-bg"]=t.getAttribute("data-cell-bg")),N.reduce(((e,o)=>(t.hasAttribute(o)&&(e[o]=t.getAttribute(o)),e)),e)}cellOffset(){return this.parent?this.parent.children.indexOf(this):-1}formats(){const t={};return this.domNode.hasAttribute("data-row")&&(t.row=this.domNode.getAttribute("data-row")),this.domNode.hasAttribute("data-cell-bg")&&(t["cell-bg"]=this.domNode.getAttribute("data-cell-bg")),N.reduce(((t,e)=>(this.domNode.hasAttribute(e)&&(t[e]=this.domNode.getAttribute(e)),t)),t)}toggleAttribute(t,e){e?this.domNode.setAttribute(t,e):this.domNode.removeAttribute(t)}formatChildren(t,e){this.children.forEach((o=>{o.format(t,e)}))}format(t,e){N.indexOf(t)>-1?(this.toggleAttribute(t,e),this.formatChildren(t,e)):["row"].indexOf(t)>-1?(this.toggleAttribute(`data-${t}`,e),this.formatChildren(t,e)):"cell-bg"===t?(this.toggleAttribute("data-cell-bg",e),this.formatChildren(t,e),this.domNode.style.backgroundColor=e||"initial"):super.format(t,e)}optimize(t){const e=this.domNode.getAttribute("data-row");!this.statics.requiredContainer||this.parent instanceof this.statics.requiredContainer||this.wrap(this.statics.requiredContainer.blotName,{row:e}),super.optimize(t)}row(){return this.parent}rowOffset(){return this.row()?this.row().rowOffset():-1}table(){return this.row()&&this.row().table()}}q.blotName="table",q.tagName="TD";class S extends f{checkMerge(){if(super.checkMerge()&&null!=this.next.children.head){const t=this.children.head.formats(),e=this.children.tail.formats(),o=this.next.children.head.formats(),l=this.next.children.tail.formats();return t.row===e.row&&t.row===o.row&&t.row===l.row}return!1}static create(t){const e=super.create(t);return e.setAttribute("data-row",t.row),e}formats(){return["row"].reduce(((t,e)=>(this.domNode.hasAttribute(`data-${e}`)&&(t[e]=this.domNode.getAttribute(`data-${e}`)),t)),{})}optimize(t){!this.statics.requiredContainer||this.parent instanceof this.statics.requiredContainer||this.wrap(this.statics.requiredContainer.blotName),this.enforceAllowedChildren(),null!=this.uiNode&&this.uiNode!==this.domNode.firstChild&&this.domNode.insertBefore(this.uiNode,this.domNode.firstChild),this.children.length>0&&null!=this.next&&this.checkMerge()&&(this.next.moveChildren(this),this.next.remove())}rowOffset(){return this.parent?this.parent.children.indexOf(this):-1}table(){return this.parent&&this.parent.parent}}S.blotName="table-row",S.tagName="TR";class T extends f{}T.blotName="table-body",T.tagName="TBODY";class A extends g{static create(t){let e=super.create(t);return w.forEach((o=>{e.setAttribute(`${o}`,t[o]||v[o])})),e}static formats(t){return w.reduce(((e,o)=>(t.hasAttribute(`${o}`)&&(e[o]=t.getAttribute(`${o}`)||void 0),e)),{})}format(t,e){w.indexOf(t)>-1?this.domNode.setAttribute(`${t}`,e||v[t]):super.format(t,e)}html(){return this.domNode.outerHTML}}A.blotName="table-col",A.tagName="col";class E extends f{}E.blotName="table-col-group",E.tagName="colgroup";class B extends f{static create(){return super.create()}constructor(t,e){super(t,e),this.updateTableWidth()}updateTableWidth(){setTimeout((()=>{const t=this.colGroup();if(!t)return;const e=t.children.reduce(((t,e)=>t+parseInt(e.formats()[A.blotName].width,10)),0);this.domNode.style.width=`${e}px`}),0)}cells(t){return this.rows().map((e=>e.children.at(t)))}colGroup(){return this.children.head}deleteColumns(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],o=arguments.length>2?arguments[2]:void 0;const[l]=this.descendants(T);if(null==l||null==l.children.head)return;const i=this.descendants(q),s=[],n=[];if(i.forEach((e=>{const l=a(e.domNode.getBoundingClientRect(),o);l.x+5>t.x&&l.x1-5<t.x1?s.push(e):l.x<t.x+5&&l.x1>t.x1-5&&n.push(e)})),s.length===i.length)return this.tableDestroy(),!0;e.forEach((t=>{this.colGroup().children.at(e[0]).remove()})),s.forEach((t=>{t.remove()})),n.forEach((t=>{const o=parseInt(t.formats().colspan,10);parseInt(t.formats().width,10),t.format("colspan",o-e.length)})),this.updateTableWidth()}deleteRow(t,e){const[o]=this.descendants(T);if(null==o||null==o.children.head)return;const l=this.descendants(q),i=this.descendants(S),s=[],n=[],r=[],d=i.filter((o=>{const l=a(o.domNode.getBoundingClientRect(),e);return l.y>t.y-5&&l.y1<t.y1+5}));if(l.forEach((o=>{const l=a(o.domNode.getBoundingClientRect(),e);l.y>t.y-5&&l.y1<t.y1+5?s.push(o):l.y<t.y+5&&l.y1>t.y1-5&&(n.push(o),Math.abs(l.y-t.y)<5&&r.push(o))})),s.length===l.length)return void this.tableDestroy();const c=this.rows().reduce(((o,l)=>{let i=a(l.domNode.getBoundingClientRect(),e);return i.y>t.y-5&&i.y1<t.y1+5&&(o+=1),o}),0);r.forEach((t=>{const o=a(t.domNode.getBoundingClientRect(),e),l=t.parent.next,i=l.children.reduce(((t,l)=>{const i=a(l.domNode.getBoundingClientRect(),e);return Math.abs(o.x1-i.x)<5&&(t=l),t}),null);l.insertBefore(t,i),t.format("row",l.formats().row)})),s.forEach((t=>{t.remove()})),n.forEach((t=>{const e=parseInt(t.formats().rowspan,10);t.format("rowspan",e-c)})),d.forEach((t=>t.remove()))}tableDestroy(){const t=n().find(this.scroll.domNode.parentNode),e=t.getModule("better-table");this.remove(),e.hideTableTools(),t.update(n().sources.USER)}insertCell(t,e){const o=R(),l=t.formats().row,i=this.scroll.create(q.blotName,Object.assign({},y,{row:l})),s=this.scroll.create(C.blotName,{row:l,cell:o});i.appendChild(s),e?t.insertBefore(i,e):t.appendChild(i)}insertColumn(t,e){let o=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],l=arguments.length>3?arguments[3]:void 0;const[i]=this.descendants(T),[s]=this.descendants(E),n=this.descendants(A);let r=[],d=[],c=[];if(null==i||null==i.children.head)return;this.descendants(q).forEach((e=>{const i=a(e.domNode.getBoundingClientRect(),l);o?Math.abs(i.x1-t.x1)<5?r.push(e):t.x1-i.x>5&&t.x1-i.x1<-5&&d.push(e):Math.abs(i.x-t.x)<5?r.push(e):t.x-i.x>5&&t.x-i.x1<-5&&d.push(e)})),r.forEach((t=>{const e=o?t.next:t,l=R(),i=t.parent,s=i.formats().row,n=t.formats(),r=this.scroll.create(q.blotName,Object.assign({},y,{row:s,rowspan:n.rowspan})),a=this.scroll.create(C.blotName,{row:s,cell:l,rowspan:n.rowspan});r.appendChild(a),e?i.insertBefore(r,e):i.appendChild(r),c.push(r)}));const h=this.scroll.create(A.blotName,!0);let u=o?n[e].next:n[e];return u?s.insertBefore(h,u):s.appendChild(h),d.forEach((t=>{const e=t.formats().colspan;t.format("colspan",parseInt(e,10)+1),c.push(t)})),c.sort(((t,e)=>t.domNode.getBoundingClientRect().y-e.domNode.getBoundingClientRect().y)),this.updateTableWidth(),c}insertRow(t,e,o){const[l]=this.descendants(T);if(null==l||null==l.children.head)return;const i=this.descendants(q),s=M(),n=this.scroll.create(S.blotName,{row:s});let r=[],d=[],c=[];i.forEach((l=>{const i=a(l.domNode.getBoundingClientRect(),o);e?Math.abs(i.y1-t.y1)<5?r.push(l):t.y1-i.y>5&&t.y1-i.y1<-5&&d.push(l):Math.abs(i.y-t.y)<5?r.push(l):t.y-i.y>5&&t.y-i.y1<-5&&d.push(l)}));const h=(t,e)=>t.domNode.getBoundingClientRect().x-e.domNode.getBoundingClientRect().x;r.sort(h),r.forEach((t=>{const e=R(),o=t.formats(),l=this.scroll.create(q.blotName,Object.assign({},y,{row:s,colspan:o.colspan})),i=this.scroll.create(C.blotName,{row:s,cell:e,colspan:o.colspan}),r=this.scroll.create(b.blotName);i.appendChild(r),l.appendChild(i),n.appendChild(l),c.push(l)})),d.forEach((t=>{const e=parseInt(t.formats().rowspan,10);t.format("rowspan",e+1),c.push(t)}));const u=this.rows().find((l=>{let i=a(l.domNode.getBoundingClientRect(),o);return e?Math.abs(i.y-t.y-t.height)<5:Math.abs(i.y-t.y)<5}));return l.insertBefore(n,u),c.sort(h),c}mergeCells(t,e,o,l,i){const s=e.reduce(((t,e,i)=>(0!==i?(t&&e.moveChildren(t),e.remove()):(e.format("colspan",l),e.format("rowspan",o),t=e),t)),null);let n=s.domNode.getAttribute("data-row"),r=s.children.head.domNode.getAttribute("data-cell");return s.children.forEach((t=>{t.format("cell",r),t.format("row",n),t.format("colspan",l),t.format("rowspan",o)})),s}unmergeCells(t,e){let o={},l=1,i=1;t.forEach((t=>{if(o=t.formats(),l=o.rowspan,i=o.colspan,i>1){let e=t.next,o=t.row();t.format("colspan",1);for(let t=i;t>1;t--)this.insertCell(o,e)}if(l>1){let o=l,s=t.row().next;for(;o>1;){let l=s.children.reduce(((o,l)=>{let i=a(t.domNode.getBoundingClientRect(),e),s=a(l.domNode.getBoundingClientRect(),e);return Math.abs(i.x1-s.x)<5&&(o=l),o}),null);for(let t=i;t>0;t--)this.insertCell(s,l);o-=1,s=s.next}t.format("rowspan",1)}}))}rows(){const t=this.children.tail;return null==t?[]:t.children.map((t=>t))}}B.blotName="table-container",B.className="quill-better-table",B.tagName="TABLE";class L extends f{constructor(t,e){super(t,e);const o=n().find(t.domNode.parentNode);e.addEventListener("scroll",(t=>{const e=o.getModule("better-table");e.columnTool&&(e.columnTool.domNode.scrollLeft=t.target.scrollLeft),e.tableSelection&&e.tableSelection.selectedTds.length>0&&e.tableSelection.repositionHelpLines()}),!1)}table(){return this.children.head}}function M(){return`row-${Math.random().toString(36).slice(2,6)}`}function R(){return`cell-${Math.random().toString(36).slice(2,6)}`}L.blotName="table-view",L.className="quill-better-table-wrapper",L.tagName="DIV",L.allowedChildren=[B],B.requiredContainer=L,B.allowedChildren=[T,E],T.requiredContainer=B,T.allowedChildren=[S],S.requiredContainer=T,S.allowedChildren=[q],q.requiredContainer=S,q.allowedChildren=[C,m],C.requiredContainer=q,E.allowedChildren=[A],E.requiredContainer=B,A.requiredContainer=E;const H=["left","right","top","bottom"];class D{constructor(t,e,o){if(!t)return null;this.table=t,this.quill=e,this.options=o,this.boundary={},this.selectedTds=[],this.dragging=!1,this.selectingHandler=this.mouseDownHandler.bind(this),this.clearSelectionHandler=this.clearSelection.bind(this),this.helpLinesInitial(),this.quill.root.addEventListener("mousedown",this.selectingHandler,!1),this.quill.on("text-change",this.clearSelectionHandler)}helpLinesInitial(){let t=this.quill.root.parentNode;H.forEach((e=>{this[e]=document.createElement("div"),this[e].classList.add("qlbt-selection-line"),this[e].classList.add("qlbt-selection-line-"+e),r(this[e],{position:"absolute",display:"none","background-color":"#0589f3"}),t.appendChild(this[e])}))}mouseDownHandler(t){if(0!==t.button||!t.target.closest(".quill-better-table"))return;this.quill.root.addEventListener("mousemove",i,!1),this.quill.root.addEventListener("mouseup",(function t(o){e.quill.root.removeEventListener("mousemove",i,!1),e.quill.root.removeEventListener("mouseup",t,!1),e.dragging=!1}),!1);const e=this,o=t.target.closest("td[data-row]"),l=a(o.getBoundingClientRect(),this.quill.root.parentNode);function i(t){if(0!==t.button||!t.target.closest(".quill-better-table"))return;const i=t.target.closest("td[data-row]"),s=a(i.getBoundingClientRect(),e.quill.root.parentNode);e.boundary=z(l,s),e.correctBoundary(),e.selectedTds=e.computeSelectedTds(),e.repositionHelpLines(),o!==i&&e.quill.blur()}this.dragging=!0,this.boundary=z(l,l),this.correctBoundary(),this.selectedTds=this.computeSelectedTds(),this.repositionHelpLines()}correctBoundary(){n().find(this.table).descendants(q).forEach((t=>{let{x:e,y:o,width:l,height:i}=a(t.domNode.getBoundingClientRect(),this.quill.root.parentNode);(e+2>=this.boundary.x&&e+2<=this.boundary.x1||e-2+l>=this.boundary.x&&e-2+l<=this.boundary.x1)&&(o+2>=this.boundary.y&&o+2<=this.boundary.y1||o-2+i>=this.boundary.y&&o-2+i<=this.boundary.y1)&&(this.boundary=z(this.boundary,{x:e,y:o,width:l,height:i}))}))}computeSelectedTds(){return n().find(this.table).descendants(q).reduce(((t,e)=>{let{x:o,y:l,width:i,height:s}=a(e.domNode.getBoundingClientRect(),this.quill.root.parentNode);return o+2>=this.boundary.x&&o-2+i<=this.boundary.x1&&l+2>=this.boundary.y&&l-2+s<=this.boundary.y1&&t.push(e),t}),[])}repositionHelpLines(){const t=this.table.parentNode.scrollLeft;r(this.left,{display:"block",left:this.boundary.x-t-1+"px",top:`${this.boundary.y}px`,height:`${this.boundary.height+1}px`,width:"1px"}),r(this.right,{display:"block",left:this.boundary.x1-t+"px",top:`${this.boundary.y}px`,height:`${this.boundary.height+1}px`,width:"1px"}),r(this.top,{display:"block",left:this.boundary.x-1-t+"px",top:`${this.boundary.y}px`,width:`${this.boundary.width+1}px`,height:"1px"}),r(this.bottom,{display:"block",left:this.boundary.x-1-t+"px",top:`${this.boundary.y1+1}px`,width:`${this.boundary.width+1}px`,height:"1px"})}refreshHelpLinesPosition(){const t=a(this.selectedTds[0].domNode.getBoundingClientRect(),this.quill.root.parentNode),e=a(this.selectedTds[this.selectedTds.length-1].domNode.getBoundingClientRect(),this.quill.root.parentNode);this.boundary=z(t,e),this.repositionHelpLines()}destroy(){return H.forEach((t=>{this[t].remove(),this[t]=null})),this.quill.root.removeEventListener("mousedown",this.selectingHandler,!1),this.quill.off("text-change",this.clearSelectionHandler),null}setSelection(t,e){this.boundary=z(a(t,this.quill.root.parentNode),a(e,this.quill.root.parentNode)),this.correctBoundary(),this.selectedTds=this.computeSelectedTds(),this.repositionHelpLines()}clearSelection(){this.boundary={},this.selectedTds=[],H.forEach((t=>{this[t]&&r(this[t],{display:"none"})}))}}function z(t,e){let o=Math.min(t.x,e.x,t.x+t.width-1,e.x+e.width-1),l=Math.max(t.x,e.x,t.x+t.width-1,e.x+e.width-1),i=Math.min(t.y,e.y,t.y+t.height-1,e.y+e.height-1),s=Math.max(t.y,e.y,t.y+t.height-1,e.y+e.height-1);return{x:o,x1:l,y:i,y1:s,width:l-o,height:s-i}}const V=["white","red","yellow","blue"],O={insertColumnRight:{text:"Insert column right",iconSrc:'<?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg class="icon" width="20px" height="20px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"><path fill="#595959" d="M73.142857 336.64h526.628572v43.885714H73.142857zM73.142857 643.657143h526.628572v43.885714H73.142857zM336.457143 117.028571h43.885714v789.942858h-43.885714zM204.8 73.142857h614.4a131.657143 131.657143 0 0 1 131.657143 131.657143v614.4a131.657143 131.657143 0 0 1-131.657143 131.657143H204.8A131.657143 131.657143 0 0 1 73.142857 819.2V204.8A131.84 131.84 0 0 1 204.8 73.142857z m0 43.885714a87.771429 87.771429 0 0 0-87.771429 87.771429v614.4a87.771429 87.771429 0 0 0 87.771429 87.771429h614.4a87.771429 87.771429 0 0 0 87.771429-87.771429V204.8a87.771429 87.771429 0 0 0-87.771429-87.771429zM819.2 73.142857h-219.428571v877.714286h219.428571a131.657143 131.657143 0 0 0 131.657143-131.657143V204.8A131.84 131.84 0 0 0 819.2 73.142857z m44.068571 460.982857h-65.828571v65.828572H753.371429v-65.828572h-65.828572V490.057143h65.828572v-65.828572h44.068571v65.828572h65.828571z"/></svg>',handler(){const t=n().find(this.table);let e=I(this.columnToolCells,this.boundary,((t,e)=>Math.abs(t.x+t.width-e.x1)<=5),this.quill.root.parentNode);const o=t.insertColumn(this.boundary,e,!0,this.quill.root.parentNode);this.tableColumnTool.updateToolCells(),this.quill.update(n().sources.USER),this.quill.setSelection(this.quill.getIndex(o[0]),0,n().sources.SILENT),this.tableSelection.setSelection(o[0].domNode.getBoundingClientRect(),o[0].domNode.getBoundingClientRect())}},insertColumnLeft:{text:"Insert column left",iconSrc:'<?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg class="icon" width="20px" height="20.00px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"><path fill="#595959" d="M380.342857 336.457143h526.811429v43.885714H380.342857z m0 307.2h526.811429v43.885714H380.342857zM643.657143 117.028571h43.885714v789.942858h-43.885714zM204.8 73.142857h614.582857A131.474286 131.474286 0 0 1 950.857143 204.8v614.4a131.657143 131.657143 0 0 1-131.657143 131.657143H204.8A131.657143 131.657143 0 0 1 73.142857 819.2V204.8A131.657143 131.657143 0 0 1 204.8 73.142857z m0 43.885714a87.588571 87.588571 0 0 0-87.588571 87.771429v614.4a87.588571 87.588571 0 0 0 87.588571 87.771429h614.582857a87.771429 87.771429 0 0 0 87.771429-87.771429V204.8a87.771429 87.771429 0 0 0-87.771429-87.771429zM204.8 73.142857A131.657143 131.657143 0 0 0 73.142857 204.8v614.4a131.657143 131.657143 0 0 0 131.657143 131.657143h219.428571V73.142857z m131.84 460.8h-65.828571v65.828572h-43.885715v-65.828572h-65.828571v-43.885714h65.828571v-65.828572h43.885715v65.828572h65.828571z"/></svg>',handler(){const t=n().find(this.table);let e=I(this.columnToolCells,this.boundary,((t,e)=>Math.abs(t.x-e.x)<=5),this.quill.root.parentNode);const o=t.insertColumn(this.boundary,e,!1,this.quill.root.parentNode);this.tableColumnTool.updateToolCells(),this.quill.update(n().sources.USER),this.quill.setSelection(this.quill.getIndex(o[0]),0,n().sources.SILENT),this.tableSelection.setSelection(o[0].domNode.getBoundingClientRect(),o[0].domNode.getBoundingClientRect())}},insertRowUp:{text:"Insert row up",iconSrc:'<?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg class="icon" width="20px" height="20.00px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"><path fill="#595959" d="M73.142857 599.771429h877.714286v43.885714H73.142857zM336.457143 380.342857h43.885714v526.628572h-43.885714z m307.2 0h43.885714v526.628572h-43.885714zM204.8 73.142857h614.4a131.657143 131.657143 0 0 1 131.657143 131.657143v614.4a131.657143 131.657143 0 0 1-131.657143 131.657143H204.8A131.657143 131.657143 0 0 1 73.142857 819.2V204.8A131.657143 131.657143 0 0 1 204.8 73.142857z m0 43.885714a87.771429 87.771429 0 0 0-87.771429 87.771429v614.4a87.588571 87.588571 0 0 0 87.771429 87.771429h614.4a87.588571 87.588571 0 0 0 87.771429-87.771429V204.8a87.771429 87.771429 0 0 0-87.771429-87.771429zM819.2 73.142857H204.8A131.657143 131.657143 0 0 0 73.142857 204.8v219.428571h877.714286v-219.428571A131.657143 131.657143 0 0 0 819.2 73.142857z m-219.428571 197.485714h-65.828572v65.828572h-43.885714v-65.828572h-65.828572v-43.885714h65.828572V160.914286h43.885714v65.828571h65.828572z"/></svg>',handler(){const t=n().find(this.table).insertRow(this.boundary,!1,this.quill.root.parentNode);this.quill.update(n().sources.USER),this.quill.setSelection(this.quill.getIndex(t[0]),0,n().sources.SILENT),this.tableSelection.setSelection(t[0].domNode.getBoundingClientRect(),t[0].domNode.getBoundingClientRect())}},insertRowDown:{text:"Insert row down",iconSrc:'<?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg class="icon" width="20px" height="20.00px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"><path fill="#595959" d="M204.8 73.142857h614.4a131.657143 131.657143 0 0 1 131.657143 131.657143v614.4a131.657143 131.657143 0 0 1-131.657143 131.657143H204.8A131.657143 131.657143 0 0 1 73.142857 819.2V204.8A131.84 131.84 0 0 1 204.8 73.142857z m0 43.885714a87.771429 87.771429 0 0 0-87.771429 87.771429v614.4a87.771429 87.771429 0 0 0 87.771429 87.771429h614.4a87.771429 87.771429 0 0 0 87.771429-87.771429V204.8a87.771429 87.771429 0 0 0-87.771429-87.771429zM73.142857 336.457143h877.714286v44.068571H73.142857zM336.64 117.028571h43.885714v526.628572h-43.885714z m307.017143 0h44.068571v526.628572H643.657143zM73.142857 599.771429v219.428571a131.657143 131.657143 0 0 0 131.657143 131.657143h614.4a131.657143 131.657143 0 0 0 131.657143-131.657143v-219.428571z m526.628572 197.485714h-65.645715v65.828571H490.057143v-65.828571h-65.828572v-43.885714h65.828572v-65.828572h44.068571v65.828572h65.645715z"/></svg>',handler(){const t=n().find(this.table).insertRow(this.boundary,!0,this.quill.root.parentNode);this.quill.update(n().sources.USER),this.quill.setSelection(this.quill.getIndex(t[0]),0,n().sources.SILENT),this.tableSelection.setSelection(t[0].domNode.getBoundingClientRect(),t[0].domNode.getBoundingClientRect())}},mergeCells:{text:"Merge selected cells",iconSrc:'<?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg class="icon" width="20px" height="20.00px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"><path fill="#595959" d="M925.99596 99.038384c-25.470707-25.6-60.121212-39.822222-96.323233-39.822222H194.19798c-36.072727 0-70.723232 14.351515-96.323233 39.822222-25.6 25.6-39.822222 60.121212-39.822222 96.323232v635.474748c0 36.072727 14.351515 70.723232 39.822222 96.323232C123.474747 952.759596 158.125253 967.111111 194.19798 967.111111h635.474747c36.072727 0 70.723232-14.351515 96.323233-39.951515 25.6-25.6 39.951515-60.121212 39.951515-96.323232V195.361616c0-36.072727-14.351515-70.723232-39.951515-96.323232z m-277.850505 5.559596v226.909091H375.725253V104.59798h272.420202zM103.434343 195.361616c0-24.048485 9.567677-47.191919 26.634344-64.129293 17.066667-17.066667 40.080808-26.634343 64.129293-26.634343h136.145454v226.909091H103.434343V195.361616z m90.763637 726.367677c-24.048485 0-47.191919-9.567677-64.129293-26.634344-17.066667-17.066667-26.634343-40.080808-26.634344-64.129292V649.309091h226.909091v272.420202H194.19798z m181.527273 0V649.309091h272.290909v272.420202H375.725253z m544.711111-90.892929c0 24.048485-9.567677 47.191919-26.634344 64.129293-17.066667 17.066667-40.080808 26.634343-64.129293 26.634343H693.527273V649.309091h226.909091v181.527273zM693.527273 331.507071V104.59798h136.145454c24.048485 0 47.191919 9.567677 64.129293 26.634343 17.066667 17.066667 26.634343 40.080808 26.634344 64.129293v136.145455H693.527273z"/></svg>',handler(){const t=n().find(this.table),e=t.rows().reduce(((t,e)=>{let o=a(e.domNode.getBoundingClientRect(),this.quill.root.parentNode);return o.y>this.boundary.y-5&&o.y+o.height<this.boundary.y+this.boundary.height+5&&(t+=1),t}),0),o=this.columnToolCells.reduce(((t,e)=>{let o=a(e.getBoundingClientRect(),this.quill.root.parentNode);return o.x>this.boundary.x-5&&o.x+o.width<this.boundary.x+this.boundary.width+5&&(t+=1),t}),0),l=t.mergeCells(this.boundary,this.selectedTds,e,o,this.quill.root.parentNode);this.quill.update(n().sources.USER),this.tableSelection.setSelection(l.domNode.getBoundingClientRect(),l.domNode.getBoundingClientRect())}},unmergeCells:{text:"Unmerge cells",iconSrc:'<?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg class="icon" width="20px" height="20.00px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"><path fill="#595959" d="M336.457143 73.142857h43.885714v877.714286h-43.885714z m307.382857 0h43.702857v877.714286h-43.702857z m-438.857143 0h614.4A131.657143 131.657143 0 0 1 950.857143 204.8v614.4a131.474286 131.474286 0 0 1-131.474286 131.657143h-614.4A131.657143 131.657143 0 0 1 73.142857 819.2V204.8A131.84 131.84 0 0 1 204.982857 73.142857z m0 43.885714a87.588571 87.588571 0 0 0-87.771428 87.771429v614.4a87.588571 87.588571 0 0 0 87.771428 87.771429h614.4a87.771429 87.771429 0 0 0 87.771429-87.771429V204.8a87.771429 87.771429 0 0 0-87.771429-87.771429zM73.142857 336.457143h877.714286v307.2H73.142857z m292.571429 43.885714v219.428572h292.571428v-219.428572z"/></svg>',handler(){n().find(this.table).unmergeCells(this.selectedTds,this.quill.root.parentNode),this.quill.update(n().sources.USER),this.tableSelection.clearSelection()}},deleteColumn:{text:"Delete selected columns",iconSrc:'<?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg class="icon" width="20px" height="20.00px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"><path fill="#595959" d="M925.996 99.038c-25.47-25.6-60.121-39.822-96.323-39.822H194.198c-75.12 0.13-136.016 61.026-136.145 136.146v635.345c0 36.073 14.351 70.723 39.822 96.323 25.6 25.73 60.25 40.081 96.323 40.081h635.475c36.072 0 70.723-14.351 96.323-39.951 25.6-25.6 39.951-60.122 39.951-96.324V195.362c0-36.073-14.351-70.724-39.951-96.324z m-365.77 494.287L512 545.228l-48.226 48.097-32.194-31.935 48.355-48.226-48.226-48.097 32.194-32.194L512 480.97l48.097-48.097 32.194 32.194-48.097 48.097 48.226 48.226-32.194 31.935zM103.434 195.362c0-24.049 9.568-47.192 26.635-64.13 17.066-17.066 40.08-26.634 64.129-26.634h136.145v226.91H103.434V195.361z m0 181.656h226.91V649.31h-226.91V377.02z m90.764 544.84c-24.049 0-47.192-9.567-64.13-26.634-17.066-17.066-26.634-40.08-26.634-64.258V694.69h226.91v227.168H194.197z m726.238-90.763c0 24.048-9.438 47.192-26.505 64.259-17.066 17.066-40.21 26.634-64.258 26.505H693.527V694.69h226.91v136.404z m0-181.786H693.527V377.02h226.91v272.29zM693.527 331.507V104.598h136.146c24.048 0 47.192 9.438 64.258 26.505 17.067 17.067 26.635 40.21 26.505 64.259v136.145H693.527z"/></svg>',handler(){const t=n().find(this.table);let e=(o=this.columnToolCells,l=this.boundary,i=(t,e)=>t.x+5>e.x&&t.x+t.width-5<e.x1,s=this.quill.root.parentNode,o.reduce(((t,e)=>{let n=a(e.getBoundingClientRect(),s);return i(n,l)&&t.push(o.indexOf(e)),t}),[]));var o,l,i,s;t.deleteColumns(this.boundary,e,this.quill.root.parentNode)||(this.tableColumnTool.updateToolCells(),this.quill.update(n().sources.USER),this.tableSelection.clearSelection())}},deleteRow:{text:"Delete selected rows",iconSrc:'<?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg class="icon" width="20px" height="20.00px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"><path fill="#595959" d="M925.99596 99.038384c-25.470707-25.6-60.121212-39.822222-96.323233-39.822222H194.19798c-36.072727 0-70.723232 14.351515-96.323233 39.822222-25.6 25.6-39.822222 60.121212-39.822222 96.323232v635.474748c0 36.072727 14.351515 70.723232 39.822222 96.323232C123.474747 952.759596 158.125253 967.111111 194.19798 967.111111h635.474747c36.072727 0 70.723232-14.351515 96.323233-39.951515 25.6-25.6 39.951515-60.121212 39.951515-96.323232V195.361616c0-36.072727-14.351515-70.723232-39.951515-96.323232z m-550.270707 5.559596h272.290909v227.167677H375.725253V104.59798z m56.242424 360.468687l31.935353-32.19394 48.09697 48.226263 48.09697-48.226263 32.193939 32.19394-48.09697 48.096969 48.226263 48.226263-32.193939 31.935354-48.226263-48.09697-48.226263 48.09697-31.935353-31.935354 48.226262-48.226263-48.096969-48.096969zM103.434343 195.361616c0-24.048485 9.567677-47.191919 26.634344-64.129293 17.066667-17.066667 40.080808-26.634343 64.129293-26.634343h136.145454v227.167677H103.434343V195.361616z m817.002021 635.733333c0 24.048485-9.567677 47.191919-26.634344 64.258586-17.066667 17.066667-40.080808 26.634343-64.129293 26.634344H194.19798c-24.048485 0-47.191919-9.567677-64.258586-26.634344C112.872727 878.157576 103.434343 855.014141 103.434343 830.836364V694.690909h226.909091v226.909091h45.381819V694.690909h272.290909v226.909091h45.381818V694.690909h226.909091v136.40404z m0-499.329292H693.527273V104.59798h136.145454c24.048485 0 47.191919 9.567677 64.129293 26.634343 17.066667 17.066667 26.634343 40.080808 26.634344 64.129293v136.404041z"/></svg>',handler(){n().find(this.table).deleteRow(this.boundary,this.quill.root.parentNode),this.quill.update(n().sources.USER),this.tableSelection.clearSelection()}},deleteTable:{text:"Delete table",iconSrc:'<?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg class="icon" width="20px" height="20.00px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"><path fill="#595959" d="M764.42168889 830.5152c0 30.23530667-24.61013333 54.84430222-54.84316444 54.84430222H314.42147555c-30.23416889 0-54.84316445-24.61013333-54.84316444-54.84430222V248.32796445h504.84337778v582.18723555zM369.26577778 149.89084445c0-6.32832 4.92202667-11.25034667 11.25034667-11.25034667H644.18702222c6.32832 0 11.25034667 4.92202667 11.25034667 11.25034667v33.04675555H369.26577778V149.89084445z m559.68768 33.04675555H720.82773333V149.89084445c0-42.1888-34.45191111-76.64071111-76.64071111-76.64071112H380.51612445c-42.1888 0-76.64071111 34.45191111-76.64071112 76.64071112v33.04675555h-208.82773333c-18.28181333 0-33.04789333 14.76608-33.04789333 33.04675555s14.76608 33.04675555 33.04675555 33.04675556h98.43825778v581.48408889c0 66.79779555 54.14001778 120.93781333 120.93667555 120.93781333h395.1570489c66.79665778 0 120.93667555-54.14001778 120.93667555-120.93781333V248.32796445h98.43825778c18.28067555 0 33.04675555-14.76494222 33.04675555-33.04675556s-14.76608-32.34360889-33.04675555-32.34360889zM512 786.21923555c18.28181333 0 33.04675555-14.76608 33.04675555-33.04789333v-351.56195555c0-18.28181333-14.76494222-33.04675555-33.04675555-33.04675556s-33.04675555 14.76494222-33.04675555 33.04675556v351.56195555c0 18.28181333 14.76494222 33.04789333 33.04675555 33.04789333m-153.98456889 0c18.28181333 0 33.04675555-14.76608 33.04675556-33.04789333v-351.56195555c0-18.28181333-14.76494222-33.04675555-33.04675556-33.04675556s-33.04675555 14.76494222-33.04675556 33.04675556v351.56195555c0.70314667 18.28181333 15.46922667 33.04789333 33.04675556 33.04789333m307.96913778 0c18.28067555 0 33.04675555-14.76608 33.04675556-33.04789333v-351.56195555c0-18.28181333-14.76608-33.04675555-33.04675556-33.04675556s-33.04675555 14.76494222-33.04675556 33.04675556v351.56195555c0 18.28181333 14.76494222 33.04789333 33.04675556 33.04789333"/></svg>',handler(){const t=this.quill.getModule("better-table"),e=n().find(this.table);t.hideTableTools(),e.remove(),this.quill.update(n().sources.USER)}}};class k{constructor(t,e,o){const l=e.getModule("better-table");this.tableSelection=l.tableSelection,this.table=t.table,this.quill=e,this.options=o,this.menuItems=Object.assign({},O,o.items),this.tableColumnTool=l.columnTool,this.boundary=this.tableSelection.boundary,this.selectedTds=this.tableSelection.selectedTds,this.destroyHandler=this.destroy.bind(this),this.columnToolCells=this.tableColumnTool.colToolCells(),this.colorSubTitle=o.color&&o.color.text?o.color.text:"Background Colors",this.cellColors=o.color&&o.color.colors?o.color.colors:V,this.menuInitial(t),this.mount(),document.addEventListener("click",this.destroyHandler,!1)}mount(){document.body.appendChild(this.domNode)}destroy(){return this.domNode.remove(),document.removeEventListener("click",this.destroyHandler,!1),null}menuInitial(t){let{table:e,left:o,top:l}=t;this.domNode=document.createElement("div"),this.domNode.classList.add("qlbt-operation-menu"),r(this.domNode,{position:"absolute",left:`${o}px`,top:`${l}px`,"min-height":"150px",width:"200px"});for(let t in this.menuItems)this.menuItems[t]&&(this.domNode.appendChild(this.menuItemCreator(Object.assign({},O[t],this.menuItems[t]))),["insertRowDown","unmergeCells"].indexOf(t)>-1&&this.domNode.appendChild(i()));function i(){const t=document.createElement("div");return t.classList.add("qlbt-operation-menu-dividing"),t}this.options.color&&!1!==this.options.color&&(this.domNode.appendChild(i()),this.domNode.appendChild(function(t){const e=document.createElement("div");return e.classList.add("qlbt-operation-menu-subtitle"),e.innerText=t,e}(this.colorSubTitle)),this.domNode.appendChild(this.colorsItemCreator(this.cellColors)))}colorsItemCreator(t){const e=this,o=document.createElement("div");return o.classList.add("qlbt-operation-color-picker"),t.forEach((t=>{let l=function(t){const o=document.createElement("div");return o.classList.add("qlbt-operation-color-picker-item"),o.setAttribute("data-color",t),o.style.backgroundColor=t,o.addEventListener("click",(function(){const o=e.tableSelection.selectedTds;o&&o.length>0&&o.forEach((e=>{e.format("cell-bg",t)}))}),!1),o}(t);o.appendChild(l)})),o}menuItemCreator(t){let{text:e,iconSrc:o,handler:l}=t;const i=document.createElement("div");i.classList.add("qlbt-operation-menu-item");const s=document.createElement("span");s.classList.add("qlbt-operation-menu-icon"),s.innerHTML=o;const n=document.createElement("span");return n.classList.add("qlbt-operation-menu-text"),n.innerText=e,i.appendChild(s),i.appendChild(n),i.addEventListener("click",l.bind(this),!1),i}}function I(t,e,o,l){return t.reduce(((i,s)=>{let n=a(s.getBoundingClientRect(),l);return o(n,e)&&(i=t.indexOf(s)),i}),!1)}const $=n().import("delta");function U(t,e,o){const l=t.parentNode,i="TABLE"===l.parentNode.tagName?l.parentNode:l.parentNode.parentNode,s=Array.from(i.querySelectorAll("tr")),n=Array.from(l.querySelectorAll("td")),r=s.indexOf(l)+1,a=n.indexOf(t)+1,c=t.getAttribute("colspan")||!1,h=t.getAttribute("rowspan")||!1,u=t.getAttribute("data-cell-bg")||t.style.backgroundColor;return 0===e.length()?e=(new $).insert("\n",{"table-cell-line":{row:r,cell:a,rowspan:h,colspan:c}}):(e=e.reduce(((t,e)=>{if(e.insert&&"string"==typeof e.insert){const o=[];let l=e.insert,i=0;for(let t=0;t<e.insert.length;t++)"\n"===l.charAt(t)&&(0===t||o.push(l.substring(i,t)),o.push("\n"),i=t+1);const s=l.substring(i);s&&o.push(s),o.forEach((o=>{"\n"===o?t.insert("\n",e.attributes):t.insert(o,d(e.attributes,["table","table-cell-line"]))}))}else t.insert(e.insert,e.attributes);return t}),new $)).reduce(((t,e)=>(e.insert&&"string"==typeof e.insert&&e.insert.startsWith("\n")?t.insert(e.insert,Object.assign({},Object.assign({},{row:r},e.attributes.table),{"table-cell-line":{row:r,cell:a,rowspan:h,colspan:c,"cell-bg":u}},d(e.attributes,["table"]))):e.attributes&&e.attributes.background&&e.attributes.background===function(t){if(/^(rgb|RGB)/.test(t)){for(var e=t.toString().match(/\d+/g),o="#",l=0;l<3;l++)o+=("0"+Number(e[l]).toString(16)).slice(-2);return o}if(/^#([0-9a-fA-f]{3}|[0-9a-fA-f]{6})$/.test(t)){var i=t.replace(/#/,"").split("");if(6===i.length)return t;if(3===i.length){var s="#";for(l=0;l<i.length;l+=1)s+=i[l]+i[l];return s}}return t}(u)?t.insert(e.insert,Object.assign({},d(e.attributes,["table","table-cell-line","background"]))):t.insert(e.insert,Object.assign({},d(e.attributes,["table","table-cell-line"]))),t)),new $)}function G(t,e,o){const l=t.parentNode,i="TABLE"===l.parentNode.tagName?l.parentNode:l.parentNode.parentNode,s=Array.from(i.querySelectorAll("tr")),n=Array.from(l.querySelectorAll("th")),r=s.indexOf(l)+1,a=n.indexOf(t)+1,c=t.getAttribute("colspan")||!1,h=t.getAttribute("rowspan")||!1;return 0===e.length()?e=(new $).insert("\n",{"table-cell-line":{row:r,cell:a,rowspan:h,colspan:c}}):(e=e.reduce(((t,e)=>{if(e.insert&&"string"==typeof e.insert){const o=[];let l=e.insert,i=0;for(let t=0;t<e.insert.length;t++)"\n"===l.charAt(t)&&(0===t||o.push(l.substring(i,t)),o.push("\n"),i=t+1);const s=l.substring(i);s&&o.push(s),o.indexOf("\n")<0&&o.push("\n"),o.forEach((o=>{"\n"===o?t.insert("\n",{"table-cell-line":{row:r,cell:a,rowspan:h,colspan:c}}):t.insert(o,e.attributes)}))}else t.insert(e.insert,e.attributes);return t}),new $)).reduce(((t,e)=>(e.insert&&"string"==typeof e.insert&&e.insert.startsWith("\n")?t.insert(e.insert,Object.assign({},{"table-cell-line":{row:r,cell:a,rowspan:h,colspan:c}})):t.insert(e.insert,Object.assign({},d(e.attributes,["table","table-cell-line"]))),t)),new $)}function P(t,e,o){let l=new $;const i=t.querySelector("tr");if(null===i)return l;const s=Array.from(i.querySelectorAll("td")).concat(Array.from(i.querySelectorAll("th"))).reduce(((t,e)=>{const o=e.getAttribute("colspan")||1;return t+parseInt(o,10)}),0),n=t.querySelectorAll("col").length;if(n===s)return e;{for(let t=0;t<s-n;t++)l.insert("\n",{"table-col":!0});if(0===n)return l.concat(e);let t=0;return e.reduce(((e,o)=>(e.insert(o.insert,o.attributes),o.attributes&&o.attributes["table-col"]&&(t+=o.insert.length,t===n&&(e=e.concat(l))),e)),new $)}}const j=n().import("core/module"),W=n().import("delta");class Y extends j{static register(){n().register(A,!0),n().register(E,!0),n().register(C,!0),n().register(q,!0),n().register(S,!0),n().register(T,!0),n().register(B,!0),n().register(L,!0),n().register(L,!0)}constructor(t,e){super(t,e),this.quill.root.addEventListener("click",(o=>{const l=c(o);if(!l||l.length<=0)return;const i=l.filter((t=>t.tagName&&"TABLE"===t.tagName.toUpperCase()&&t.classList.contains("quill-better-table")))[0];if(i){if(this.table===i)return;this.table&&this.hideTableTools(),this.showTableTools(i,t,e)}else this.table&&this.hideTableTools()}),!1),this.quill.root.addEventListener("contextmenu",(o=>{if(!this.table)return!0;o.preventDefault();const l=c(o);if(!l||l.length<=0)return;const i=l.filter((t=>t.tagName&&"TABLE"===t.tagName.toUpperCase()&&t.classList.contains("quill-better-table")))[0],s=l.filter((t=>t.tagName&&"TR"===t.tagName.toUpperCase()&&t.getAttribute("data-row")))[0],n=l.filter((t=>t.tagName&&"TD"===t.tagName.toUpperCase()&&t.getAttribute("data-row")))[0];let r=this.tableSelection.selectedTds.map((t=>t.domNode)).includes(n);(this.tableSelection.selectedTds.length<=0||!r)&&this.tableSelection.setSelection(n.getBoundingClientRect(),n.getBoundingClientRect()),this.tableOperationMenu&&(this.tableOperationMenu=this.tableOperationMenu.destroy()),i&&(this.tableOperationMenu=new k({table:i,row:s,cell:n,left:o.pageX,top:o.pageY},t,e.operationMenu))}),!1),t.getModule("keyboard"),t.keyboard.addBinding({key:"Backspace"},{},(function(t,e){if(0===t.index||this.quill.getLength()<=1)return!0;const[o]=this.quill.getLine(t.index);if(0===e.offset){const[e]=this.quill.getLine(t.index-1);if(null!=e&&"table-cell-line"===e.statics.blotName&&"table-cell-line"!==o.statics.blotName)return!1}return!0}));let o=t.keyboard.bindings.Backspace.pop();t.keyboard.bindings.Backspace.splice(0,1,o),t.clipboard.addMatcher("td",U),t.clipboard.addMatcher("th",G),t.clipboard.addMatcher("table",P),t.clipboard.matchers=t.clipboard.matchers.filter((t=>"tr"!==t[0]))}getTable(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.quill.getSelection();if(null==t)return[null,null,null,-1];const[e,o]=this.quill.getLine(t.index);if(null==e||e.statics.blotName!==C.blotName)return[null,null,null,-1];const l=e.tableCell(),i=l.row();return[i.table(),i,l,o]}insertTable(t,e){const o=this.quill.getSelection(!0);if(null==o)return;let l=this.quill.getLeaf(o.index)[0],i=(new W).retain(o.index);K(l)?console.warn("Can not insert table into a table cell."):(i.insert("\n"),i=new Array(e).fill("\n").reduce(((t,e)=>(t.insert(e,{"table-col":!0}),t)),i),i=new Array(t).fill(0).reduce((t=>{let o=M();return new Array(e).fill("\n").reduce(((t,e)=>(t.insert(e,{"table-cell-line":{row:o,cell:R()}}),t)),t)}),i),this.quill.updateContents(i,n().sources.USER),this.quill.setSelection(o.index+e+1,n().sources.API))}showTableTools(t,e,o){this.table=t,this.columnTool=new h(t,e,o),this.tableSelection=new D(t,e,o)}hideTableTools(){this.columnTool&&this.columnTool.destroy(),this.tableSelection&&this.tableSelection.destroy(),this.tableOperationMenu&&this.tableOperationMenu.destroy(),this.columnTool=null,this.tableSelection=null,this.tableOperationMenu=null,this.table=null}}function X(t){return{key:t?"ArrowUp":"ArrowDown",collapsed:!0,format:["table-cell-line"],handler(e,o){const l=t?"prev":"next";if(null!=o.line[l])return!0;const i=o.line.parent,s=i.parent[l];if(null!=s&&"table-row"===s.statics.blotName){let t=s.children.head,e=parseInt(t.formats().colspan,10),o=i,l=parseInt(o.formats().colspan,10);for(;null!=o.prev;)o=o.prev,l+=parseInt(o.formats().colspan,10);for(;null!=t.next&&e<l;)t=t.next,e+=parseInt(t.formats().colspan,10);const r=t.offset(this.quill.scroll);this.quill.setSelection(r,0,n().sources.USER)}else{const e=i.table().parent[l];null!=e&&(t?this.quill.setSelection(e.offset(this.quill.scroll)+e.length()-1,0,n().sources.USER):this.quill.setSelection(e.offset(this.quill.scroll),0,n().sources.USER))}return!1}}}function K(t){return!(!t||!t.parent)&&(t.parent.statics.blotName===q.blotName||K(t.parent))}Y.keyboardBindings={"table-cell-line backspace":{key:"Backspace",format:["table-cell-line"],collapsed:!0,offset:0,handler(t,e){const[o,l]=this.quill.getLine(t.index);return!(!o.prev||"table-cell-line"!==o.prev.statics.blotName)}},"table-cell-line delete":{key:"Delete",format:["table-cell-line"],collapsed:!0,suffix:/^$/,handler(){}},"table-cell-line enter":{key:"Enter",shiftKey:null,format:["table-cell-line"],handler(t,e){if(this.quill.selection&&this.quill.selection.composing)return;const o=n().imports.parchment.Scope;t.length>0&&this.quill.scroll.deleteAt(t.index,t.length);const l=Object.keys(e.format).reduce(((t,l)=>(this.quill.scroll.query(l,o.BLOCK)&&!Array.isArray(e.format[l])&&(t[l]=e.format[l]),t)),{});this.quill.insertText(t.index,"\n",l["table-cell-line"],n().sources.USER),this.quill.setSelection(t.index+1,n().sources.SILENT),this.quill.focus(),Object.keys(e.format).forEach((t=>{null==l[t]&&(Array.isArray(e.format[t])||"link"!==t&&this.quill.format(t,e.format[t],n().sources.USER))}))}},"table-cell-line up":X(!0),"table-cell-line down":X(!1),"down-to-table":{key:"ArrowDown",collapsed:!0,handler(t,e){const o=e.line.next;if(o&&"table-view"===o.statics.blotName){const t=o.table().rows()[0].children.head.children.head;return this.quill.setSelection(t.offset(this.quill.scroll),0,n().sources.USER),!1}return!0}},"up-to-table":{key:"ArrowUp",collapsed:!0,handler(t,e){const o=e.line.prev;if(o&&"table-view"===o.statics.blotName){const t=o.table().rows(),e=t[t.length-1].children.head.children.head;return this.quill.setSelection(e.offset(this.quill.scroll),0,n().sources.USER),!1}return!0}}};const _=Y;return i.default})()));